{% extends "base.html" %}

{% block title %}Home - MedFlowAI{% endblock %}

{% block extra_head %}
<style>
    .progress-circle {
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
    }

    .progress-ring-circle {
        transition: stroke-dashoffset 1s ease-in-out;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .stat-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div x-data="{
    userId: '70b8c710-b86e-4307-ab97-fbb95a4c66d9',
    score: 75,
    status: 'Loading...',
    color: '#8B5CF6',
    showFeedback: false,
    feedback: '',
    summary: null,
    briefSummaries: {},
    loading: true,
    error: null,

    async loadHealthData() {
        try {
            this.loading = true;
            const response = await fetch(`/api/v1/generate_alert?user_id=${this.userId}`);
            if (!response.ok) throw new Error('Failed to load health data');
            
            const data = await response.json();
            this.summary = data.summary;
            this.feedback = data.feedback;
            this.briefSummaries = data.brief_summaries || {};
            
            // Calculate score based on data availability
            const totalRecords = data.summary?.total_records || 0;
            if (totalRecords >= 4) this.score = 85;
            else if (totalRecords >= 2) this.score = 65;
            else this.score = 30;
            
            this.color = this.getColorForScore(this.score);
            this.status = this.getStatusForScore(this.score);
            this.loading = false;
        } catch (err) {
            this.error = err.message;
            this.loading = false;
            this.status = 'Error loading data';
        }
    },

    getSummaryText(category) {
        return this.briefSummaries[category] || 'No data logged';
    },

    getColorForScore(score) {
        if (score >= 80) return '#10B981'; // green
        if (score >= 50) return '#8B5CF6'; // purple
        return '#EF4444'; // red
    },

    getStatusForScore(score) {
        if (score >= 80) return 'Crushing it!';
        if (score >= 50) return 'Keep going!';
        return 'Need some care';
    },

    async generateFeedback() {
        if (this.feedback) {
            this.showFeedback = true;
            return;
        }
        
        try {
            this.showFeedback = true;
            const response = await fetch(`/api/v1/generate_alert?user_id=${this.userId}`);
            if (!response.ok) throw new Error('Failed to generate feedback');
            
            const data = await response.json();
            this.feedback = data.feedback;
        } catch (err) {
            this.feedback = 'Error: ' + err.message;
        }
    }
}" x-init="await loadHealthData()" class="space-y-6">

    <!-- Logo and Header -->
    <div class="text-center">
        <img src="/assets/logopreview1.png" alt="MedFlowAI Logo" style="max-width: 350px; margin: 0 auto 16px; display: block;" />
        <p class="text-gray-600 mt-1">Welcome back, Mark!</p>
    </div>

    <!-- Progress Card -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <div>
            <h2 class="text-gray-600 text-sm font-medium mb-2">Logging Progress</h2>
            <h3 class="text-2xl font-bold text-gray-900 mb-4" x-text="status"></h3>

            <!-- Horizontal Progress Bar -->
            <div class="relative">
                <!-- Background bar -->
                <div class="w-full h-8 bg-gray-200 rounded-full overflow-hidden">
                    <!-- Progress fill -->
                    <div class="h-full rounded-full transition-all duration-1000 ease-out flex items-center justify-end pr-3"
                         :style="`width: ${score}%; background-color: ${color}`">
                        <span class="text-white text-sm font-bold" x-text="score + '%'"></span>
                    </div>
                </div>
            </div>

            <p class="text-gray-500 text-sm mt-3 text-center">Your health score today</p>
        </div>
    </div>

    <!-- Today's Summary -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <h3 class="text-lg font-bold text-gray-900 mb-4">You've logged today</h3>

        <div x-show="loading" class="text-center py-4">
            <svg class="animate-spin h-8 w-8 mx-auto text-purple-600" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-500 mt-2">Loading your health data...</p>
        </div>

        <div x-show="!loading" class="space-y-3">
            <!-- Meals -->
            <div class="flex items-center justify-between p-3 bg-orange-50 rounded-lg">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-700">Nutrition</p>
                        <p class="text-xs text-gray-500" x-text="getSummaryText('consum')"></p>
                    </div>
                </div>
                <span class="text-2xl">üçΩÔ∏è</span>
            </div>

            <!-- Sleep -->
            <div class="flex items-center justify-between p-3 bg-purple-50 rounded-lg">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-700">Sleep</p>
                        <p class="text-xs text-gray-500" x-text="getSummaryText('somn')"></p>
                    </div>
                </div>
                <span class="text-2xl">üò¥</span>
            </div>

            <!-- Vitals -->
            <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-red-500 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-700">Vitals</p>
                        <p class="text-xs text-gray-500" x-text="getSummaryText('vitale')"></p>
                    </div>
                </div>
                <span class="text-2xl">‚ù§Ô∏è</span>
            </div>

            <!-- Activity -->
            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-700">Activity</p>
                        <p class="text-xs text-gray-500" x-text="getSummaryText('sport')"></p>
                    </div>
                </div>
                <span class="text-2xl">üèÉ</span>
            </div>
        </div>
    </div>

    <!-- Get Status Button -->
    <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl shadow-lg p-6 text-white">
        <h3 class="text-lg font-bold mb-2">Want detailed feedback?</h3>
        <p class="text-sm text-blue-100 mb-4">Get AI-powered health insights based on your today's data</p>

        <button @click="generateFeedback()"
                :disabled="showFeedback && !feedback"
                class="w-full bg-white text-blue-600 font-semibold py-3 px-6 rounded-lg hover:bg-blue-50 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2">
            <span x-show="!showFeedback">Get Your Status</span>
            <span x-show="showFeedback && !feedback" class="flex items-center space-x-2">
                <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Analyzing...</span>
            </span>
            <span x-show="showFeedback && feedback">‚úì View Feedback</span>
        </button>
    </div>

    <!-- Feedback Card -->
    <div x-show="showFeedback && feedback"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform scale-95"
         x-transition:enter-end="opacity-100 transform scale-100"
         class="bg-white rounded-2xl shadow-lg p-6">
        <div class="text-center">
            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                </svg>
            </div>
            <h4 class="text-lg font-bold text-gray-900 mb-3">AI Health Feedback</h4>
            <div class="markdown-content text-gray-700 text-sm leading-relaxed text-center" x-html="marked.parse(feedback)"></div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="grid grid-cols-2 gap-4">
        <a href="/chat" class="stat-card bg-white rounded-xl shadow p-4 text-center hover:shadow-lg transition">
            <div class="text-3xl mb-2">üí¨</div>
            <p class="text-sm font-semibold text-gray-700">Chat with AI</p>
        </a>
        <a href="/add-data" class="stat-card bg-white rounded-xl shadow p-4 text-center hover:shadow-lg transition">
            <div class="text-3xl mb-2">‚ûï</div>
            <p class="text-sm font-semibold text-gray-700">Add Data</p>
        </a>
    </div>

</div>
{% endblock %}
